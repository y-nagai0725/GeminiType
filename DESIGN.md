# `GeminiType` アプリ設計書 (Ver.3.0)

このドキュメントは、AI搭載タイピング練習アプリ `GeminiType` の基本設計をまとめたものです。

## 1. アプリの目的とターゲット

### 目的（優先度順）
1.  **ポートフォリオ:** 開発者の技術力（フルスタック開発、外部API連携、コンポーネント設計、DB設計）を証明する「ポートフォリオ作品」とする。
2.  **学習ツール:** 開発者自身（ターゲットユーザー）が、タイピング上達のために「楽しく」「継続して」使える学習ツールとする。
3.  **AIの体験:** AI (Gemini API) による問題生成の面白さを体験してもらう（アプリの「特徴」とする）。

### ターゲットユーザー
* **タイピング中級者:** ある程度打てるが、さらに速度と正確性を高めたい人。
* **プログラミング学習者:** コーディング練習（英数字・記号のタイピング）も兼ねて、楽しく練習したい人。

---

## 2. 機能一覧

### メイン機能
* **タイピング機能 (独自エンジン):**
    * `romanTypingParseDictionary.json` を使用した厳格かつ柔軟な判定ロジック。
    * 「`saxtu`」のような動的な入力パターンの変化に対応。
    * **KPM (Keystrokes Per Minute)** を指標とする。
* **ユーザー認証 (JWT):**
    * 登録、ログイン（自動ログイン機能あり）。
* **ゲスト機能:**
    * 未ログインでもプレイ可能（結果保存は不可）。
* **問題生成:**
    * **AI生成:** Gemini API (Flashモデル) による動的生成。
    * **DB生成:** 登録済み問題からランダム出題。
* **結果管理:**
    * セッションごとのKPM、正確率、苦手キー、ミス数、打ったローマ字を記録。
* **管理画面:**
    * 管理者のみアクセス可能。ジャンル・問題文のCRUD。
    * ページネーション、検索、絞り込み、**試し打ちモーダル**機能。

### サブ機能(Want Have - メイン完成後)
* **AIコメント:**
    * 結果画面で、Geminiが成績に応じたアドバイスをくれる。
* **マイページ:**
    * 統計（総タイプ数、平均KPMなど）、苦手キーランキング、成長グラフ、履歴一覧。
* **セッション詳細:**
    * 1問ごとのKPM、ミス数、実際に打ったローマ字を確認可能。
* * **特殊（ゲーム）モード:**
    * タイピング設定画面で選択可能（例: 制限時間モード、ミス即終了モード）。
    * **※特殊モードの結果は、DBには一切保存しない。**

---

## 3. 画面一覧

1.  **トップページ (LP):** アプリ紹介、お試し/登録/ログインへの導線。
2.  **ユーザー登録画面:**
3.  **ログイン画面:**
4.  **メインメニュー画面:** 「AI生成」と「DBジャンル」の選択。
5.  **タイピング設定画面:** 「問題数」「特殊モード」「音設定」を選択する画面。**（※PC版に最適化）**
6.  **タイピング実行画面:** 連続タイピングを行う画面。進捗も表示。**（※PC版に最適化）**
7.  **セッション結果画面:** 問題終了後の「まとめ結果」を表示。「もう一度やる！」ボタン設置。
8.  **マイページ:** 「総計」表示、過去の「セッション履歴（一覧）」を表示。
9.  **セッション詳細画面:** マイページの履歴一覧から遷移。1セッションの「1問ごとの内訳」を表示。
10. **管理画面:** ジャンル・問題のCRUD用。「試し打ち」ボタン設置。

---

## 4. ユーザーフロー

1.  **ゲスト (未ログイン):**
    * トップページ → 「お試し」 → メニュー → 「AI生成」or「DBジャンル」選択 → 設定画面（問題数やモード選択） → タイピング実行 → セッション結果表示。
    * ※結果画面で「この結果を保存するには登録してね」と誘導。
2.  **ログインユーザー:**
    * トップページ → ログイン → メニュー → 「AI生成」or「DBジャンル」選択 → 設定画面 → タイピング実行 → セッション結果表示。
    * ※「通常モード」の場合のみ、結果は自動でDBに保存される。
    * ※結果画面の「もう一度やる！」ボタンから、タイピング実行画面(画面6)に直接ジャンプできる。
    * マイページで過去の履歴（セッション一覧）を閲覧できる。

---

## 5. データベース設計 (Prisma Schema)

### テーブル定義
* **`users`**
    * `id`, `name`, `email`, `password`, `is_admin`
* **`genres`**
    * `id`, `name` (@unique)
* **`problems`**
    * `id`, `genre_id`, `problem_text`
    * @@unique([genre_id, problem_text])
* **`typing_sessions`** (親)
    * `id`, `user_id`, `session_type`, `genre_id`, `gemini_prompt`
    * `average_kpm` (Float), `average_accuracy` (Float)
    * `most_missed_key`
    * `total_types` (Int)
    * `total_miss_count` (Int)
    * `created_at`
* **`session_problems`** (子)
    * `id`, `session_id`, `problem_text`
    * `kpm` (Float), `accuracy` (Float)
    * `miss_count` (Int)
    * `romaji_text` (String)
    * `missed_keys` (JSON String)

---

## 6. API エンドポイント一覧

### 認証・ユーザー
* `POST /api/register`: ユーザー登録
* `POST /api/login`: ログイン
* `GET /api/me`: 認証確認

### 一般公開 (ゲスト可)
* `GET /api/genres`: ジャンル一覧取得
* `GET /api/typing/db`: DB問題取得
* `GET /api/typing/gemini`: AI問題生成
* `POST /api/get-hiragana`: 漢字→ひらがな変換 (Yahoo! API)
* `POST /api/typing/ai-comment`: 結果へのAIコメント生成

### タイピング結果 (要認証)
* `POST /api/typing/result`: 結果保存 (Session & Problems)

### マイページ (要認証)
* `GET /api/mypage/stats`: 統計情報＆苦手キー取得
* `GET /api/mypage/sessions`: 履歴一覧取得 (ページング)
* `GET /api/mypage/sessions/:id`: 履歴詳細取得

### 管理画面 (要管理者権限)
* `GET /api/admin/genres`: ジャンル全取得
* `POST /api/admin/genres`: ジャンル登録
* `PUT /api/admin/genres/:id`: ジャンル更新
* `DELETE /api/admin/genres/:id`: ジャンル削除
* `GET /api/admin/problems`: 問題一覧取得 (検索・ページング)
* `POST /api/admin/problems`: 問題登録
* `PUT /api/admin/problems/:id`: 問題更新
* `DELETE /api/admin/problems/:id`: 問題削除